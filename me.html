<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿尼斯 - Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; background-color: #121212; font-family: 'Poppins', sans-serif; color: white; }

        .profile-header {
            position: relative;
            height: 280px;
            background-color: #333;
            background-size: cover;
            background-position: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            transition: background-image 0.3s ease;
        }
        .header-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), #121212);
            z-index: 1;
        }

        .header-content { position: relative; z-index: 2; }

        .header-icons {
            position: absolute; top: 20px; width: calc(100% - 40px); z-index: 3;
            display: flex; justify-content: space-between; font-size: 20px; color: white;
        }

        .user-info-main { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 10px; }
        .avatar-container { position: relative; }
        .avatar { width: 85px; height: 85px; border-radius: 50%; border: 2px solid #121212; background-color: #333; object-fit: cover; }
        
        .user-text { margin-top: 5px; }
        .user-text h2 { margin: 0; font-size: 22px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .rednote-id { font-size: 11px; color: #ccc; margin-top: 4px; }
        
        .user-bio { font-size: 13px; color: #eee; margin-top: 8px; line-height: 1.4; max-width: 90%; }
        .user-tags { display: flex; gap: 8px; margin-top: 8px; }
        .info-tag {
            background: rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 4px;
            font-size: 10px; display: flex; align-items: center; gap: 4px; color: #ddd;
        }

        .stats-bar { display: flex; gap: 20px; padding: 10px 20px; align-items: center; }
        .stat-item { text-align: left; display: flex; gap: 5px; align-items: baseline;}
        .stat-value { font-weight: 700; font-size: 16px; }
        .stat-label { font-size: 13px; color: #999; }

        .action-buttons { display: flex; gap: 10px; padding: 10px 20px; }
        .edit-btn, .settings-btn { 
            background: #333; border: 1px solid #444; color: white; 
            padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;
            flex: 1; text-align: center;
        }

        .profile-tabs { display: flex; justify-content: space-around; margin-top: 15px; border-bottom: 1px solid #222; }
        .p-tab { padding: 10px 0; color: #888; font-weight: 600; position: relative; cursor: pointer;}
        .p-tab.active { color: white; }
        .p-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: #ff2442; }

        .filter-tabs { display: flex; gap: 15px; padding: 15px 20px; font-size: 14px; color: #888; }
        .f-tab.active { color: white; font-weight: bold; }

        .notes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; padding-bottom: 100px; }
        .note-card { background: #1e1e1e; border-radius: 8px; overflow: hidden; position: relative; }
        .note-content-preview { background: #fff; color: #333; height: 150px; padding: 15px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 14px; font-weight: 600; }
        .note-info { padding: 8px; font-size: 11px; }
        .note-footer { display: flex; justify-content: space-between; color: #888; margin-top: 5px;}
        .private-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; font-size: 10px; color: white; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: #121212; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; padding: 10px 0; padding-bottom: 25px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 12px; font-weight: 600; text-decoration: none; }
        .nav-item.active { color: #fff; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .add-btn { background-color: #ff2442; width: 45px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; cursor: pointer;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; z-index: 2000; }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background-color: #1e1e1e; border-top-left-radius: 20px; border-top-right-radius: 20px; transition: bottom 0.3s ease-out; z-index: 2001; padding-bottom: 20px; }
        .bottom-sheet.show { bottom: 0; }
        .sheet-item { padding: 20px; text-align: center; border-bottom: 1px solid #2c2c2c; font-size: 18px; color: #efefef; cursor: pointer; text-decoration: none; display: block; }
    
    </style>
</head>
<body>

    <div class="profile-header" id="headerBg">
        <div class="header-overlay"></div>
        <div class="header-icons"><i class="fas fa-bars"></i><div><i class="fas fa-qrcode" style="margin-right: 15px;"></i><i class="fas fa-share"></i></div></div>
        
        <div class="header-content">
            <div class="user-info-main">
                <div class="avatar-container">
                    <img id="userAvatar" src="https://via.placeholder.com/80" class="avatar" alt="User">
                </div>
                <div class="user-text">
                    <h2 id="userName">User</h2>
                    <div class="rednote-id">ID: <span id="userId">...</span></div>
                </div>
            </div>
            
            <div class="user-bio" id="userBio"></div>
            
            <div class="user-tags" id="userTags">
                </div>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item"><span class="stat-value" id="followingCount">0</span><span class="stat-label">Following</span></div>
        <div class="stat-item"><span class="stat-value" id="followersCount">0</span><span class="stat-label">Followers</span></div>
        <div class="stat-item"><span class="stat-value" id="totalLikes">0</span><span class="stat-label">Likes&Col</span></div>
    </div>

    <div class="action-buttons">
        <button class="edit-btn" onclick="window.location.href='edit_profile.html'">Edit Profile</button>
        <button class="settings-btn"><i class="fas fa-cog"></i></button>
    </div>

    <div class="profile-tabs">
        <div class="p-tab active">Notes</div>
        <div class="p-tab">Saves</div>
        <div class="p-tab"><i class="fas fa-lock" style="font-size: 10px;"></i> Likes</div>
    </div>

    <div class="filter-tabs" id="filterContainer">
        <div class="f-tab active" onclick="filterNotes('all')">Public <span id="publicCount">0</span></div>
        <div class="f-tab" onclick="filterNotes('private')"><i class="fas fa-lock"></i> Private <span id="privateCount">0</span></div>
    </div>

    <div class="notes-grid" id="notesGrid"></div>


    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <a href="text.html" class="sheet-item">Text</a>
        <a href="image.html" class="sheet-item">Image</a>
        <a href="video.html" class="sheet-item">Video</a>
        <div class="sheet-item" id="cancelBtn">Cancel</div>
    </div>

    <footer class="bottom-nav">
        <a href="home.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="message.html" class="nav-item"><i class="fas fa-comment-dots"></i><span>Messages</span></a>
        <div class="add-btn"><i class="fas fa-plus"></i></div>
        <a href="#" class="nav-item"><i class="fas fa-bell"></i><span>Notifications</span></a>
        <a href="me.html" class="nav-item active"><i class="fas fa-user"></i><span>Me</span></a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuEfa4lBdoarHqUBmpWnVdYEhLYMUW0Wk",
            authDomain: "rednote-99494.firebaseapp.com",
            projectId: "rednote-99494",
            storageBucket: "rednote-99494.firebasestorage.app",
            messagingSenderId: "381708373042",
            appId: "1:381708373042:web:3b2b66b9aefba8b98bc02b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allUserPosts = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 1. Basic Info from Auth
                document.getElementById('userId').innerText = user.uid.substring(0, 10);
                document.getElementById('userName').innerText = user.displayName || "User";
                if(user.photoURL) document.getElementById('userAvatar').src = user.photoURL;

                // 2. Extended Info from Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // --- Display Followers and Following ---
                    document.getElementById('followingCount').innerText = data.followingCount || 0;
                    document.getElementById('followersCount').innerText = data.followersCount || 0;
                    // ---------------------------------------

                    // Background Image
                    if(data.backgroundImage) {
                        document.getElementById('headerBg').style.backgroundImage = `url('${data.backgroundImage}')`;
                    } else {
                        document.getElementById('headerBg').style.backgroundImage = `url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1000&auto=format&fit=crop')`;
                    }

                    // Bio
                    if(data.bio) {
                        document.getElementById('userBio').innerText = data.bio;
                    }

                    // Tags (Gender/Age)
                    const tagsContainer = document.getElementById('userTags');
                    tagsContainer.innerHTML = '';
                    
                    if(data.gender && data.gender !== 'Private') {
                        const icon = data.gender === 'Male' ? '<i class="fas fa-mars" style="color:#64b5f6"></i>' : '<i class="fas fa-venus" style="color:#f06292"></i>';
                        tagsContainer.innerHTML += `<div class="info-tag">${icon}</div>`;
                    }
                    
                    if(data.birthday) {
                        const birthDate = new Date(data.birthday);
                        const ageDiffMs = Date.now() - birthDate.getTime();
                        const ageDate = new Date(ageDiffMs); 
                        const age = Math.abs(ageDate.getUTCFullYear() - 1970);
                        tagsContainer.innerHTML += `<div class="info-tag">${age} yo</div>`;
                    }
                }

                fetchUserPosts(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        async function fetchUserPosts(uid) {
            const q = query(collection(db, "posts"), where("userId", "==", uid), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            allUserPosts = [];
            let totalLikes = 0;
            querySnapshot.forEach((doc) => {
                const d = doc.data();
                totalLikes += (d.likes || 0);
                allUserPosts.push({ id: doc.id, ...d });
            });
            document.getElementById('totalLikes').innerText = totalLikes;
            updateUI();
        }

        function updateUI() {
            const pubPosts = allUserPosts.filter(p => p.isPublic);
            const privPosts = allUserPosts.filter(p => !p.isPublic);
            
            document.getElementById('publicCount').innerText = pubPosts.length;
            document.getElementById('privateCount').innerText = privPosts.length;
            
            renderGrid(pubPosts);
        }

        window.filterNotes = function(type) {
            document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const filtered = (type === 'all') ? allUserPosts.filter(p => p.isPublic) : allUserPosts.filter(p => !p.isPublic);
            renderGrid(filtered);
        }

        function renderGrid(posts) {
            const grid = document.getElementById('notesGrid');
            grid.innerHTML = '';
            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.onclick = () => { window.location.href = `publication_text.html?id=${post.id}`; };
                
                const hasImages = post.images && post.images.length > 0;
                const mediaContent = hasImages 
                    ? `<div class="note-content-preview" style="padding:0; overflow:hidden;">
                            <img src="${post.images[0]}" style="width:100%; height:100%; object-fit:cover;">
                    </div>`
                    : `<div class="note-content-preview">${post.content.substring(0, 50)}...</div>`;

                card.innerHTML = `
                    ${!post.isPublic ? '<div class="private-badge"><i class="fas fa-lock"></i> Private</div>' : ''}
                    ${mediaContent}
                    <div class="note-info">
                        <div style="font-weight:600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${post.title || 'No Title'}</div>
                        <div class="note-footer">
                            <span><i class="far fa-heart"></i> ${post.likes || 0}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // UI Logic
        const addBtn = document.querySelector('.add-btn');
        const bottomSheet = document.getElementById('bottomSheet');
        const modalOverlay = document.getElementById('modalOverlay');
        const cancelBtn = document.getElementById('cancelBtn');

        if (addBtn) {
            addBtn.onclick = () => {
                modalOverlay.style.display = 'block';
                setTimeout(() => bottomSheet.classList.add('show'), 10);
            };
        }

        const closeSheet = () => {
            bottomSheet.classList.remove('show');
            setTimeout(() => modalOverlay.style.display = 'none', 300); 
        };

        if (cancelBtn) cancelBtn.onclick = closeSheet;
        if (modalOverlay) modalOverlay.onclick = closeSheet;

        // Tabs logic
        const mainTabs = document.querySelectorAll('.tab');
        mainTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                mainTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        const subTabs = document.querySelectorAll('.sub-tabs div');
        subTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                subTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });
    </script>
</body>
</html>